<!DOCTYPE html>
<html>
  <head>
    <title>Spotify Web Playback SDK Quick Start</title>
    <style>
        * {
            font-weight: 100;  
            padding: 0; 
            margin: 0;
            font-family: Helvetica, sans-serif;
        }

        body {
            height: 100%;
            margin: 0;
            background-repeat: no-repeat;
            background-attachment: fixed;
            background-image: linear-gradient(to bottom right, rgba(89,79,78,255), rgba(24,24,24,255));
        }

        img {
            display: block;
            margin-left: auto;
            margin-right: auto;
            width: 40%;
            margin-top: 40px;
        }

        h2 {
            margin-left: 30%;
            color: rgba(254,254,252,255);
        }
        
        #progress {
            width: 40%;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        p {
            margin-left: 30%;
            color: rgba(194,193,191,255);
        }

        #logContainer
        {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 300px;
            height: 400px;
            overflow-y: scroll;
            overflow-wrap: break-word;
            -ms-overflow-style: none; 
            scrollbar-width: none;
        }

        #logContainer::-webkit-scrollbar
        {
            display: none;
        }

    </style>
  </head>
  <body>
    <script src="https://sdk.scdn.co/spotify-player.js"></script>
    <script defer>

    var httpUrl = "http://localhost:9999";
    var token;
    var player;
    var ws;
    var transferred = true;
    var trackUri;
    var volumeCooldown = undefined;
    window.onSpotifyWebPlaybackSDKReady = () => {

        // Get the token from the main program API
        fetch(httpUrl + "/token")
        .then((res) => res.json())
        .then((data) => {
            token = data;
            player.connect();
            console.log("Connected with token: " + data);
        })
        .catch((err) => {
            console.log("Server is not open yet: " + err);
        });
        
        // Use token to create the Spotify player
        player = new Spotify.Player({
            name: 'Web Playback SDK Quick Start Player',
            getOAuthToken: cb => {cb(token); }
        });

        // Webpage is registered as a device
        player.addListener('ready', ({ device_id }) => {
            console.log('Ready with Device ID', device_id);
            fetch(httpUrl + "/device?id=" + device_id,
            {
                method: 'POST'
            }).then((data) => {
                transferred = true; 
                ConnectToWebSocket();
            });
        });

        // erorrs
        player.addListener('not_ready', ({ device_id }) => {
            console.log('Device ID has gone offline', device_id);
        });

        player.addListener('initialization_error', ({ message }) => { 
            console.error(message);
        });

        player.addListener('authentication_error', ({ message }) => {
            console.error(message);
        });

        player.addListener('account_error', ({ message }) => {
            console.error(message);
        });

        // Playback events
        player.addListener("progress", (o) => {
            document.getElementById("progress").value = o.position;
            let minutes = Math.floor(o.position/60000)
            let seconds = Math.floor((o.position % 60000)/1000);
            document.getElementById("timer").innerText = minutes + ":" + seconds.toString().padStart(2, "0");
        });

        // connect to the socket 

        // State changed! Update the UI and send the state to the main program via http request
        player.addListener("player_state_changed", (state => {
            if (!state)
                return;

            // Send state to main program
            /*fetch(httpUrl 
            + "/state?ms=" + state.position.toString() 
            + "&timestamp=" + Date.now() 
            + "&paused=" + state.paused, 
            {
                method: 'POST'
            }).then((data) => {
                console.log(data);
            });*/

            // Update UI
            let track = state.track_window.current_track;

            let bar = document.getElementById("progress");
            bar.setAttribute("min", 0);
            bar.setAttribute("max", track.duration_ms);

            let artists = "";
            for (let a in track.artists)
            {
                artists += track.artists[a].name + "\n";
            }
            let titleElem = document.getElementById("title");
            let artistElem = document.getElementById("artist");
            if (trackUri == track.uri) // ensure that the image does not get automatically refreshed
                return;

            trackUri = track.uri;
            titleElem.innerText = track.name;
            artistElem.innerText = artists;
            LogEvent("Play", track.name);
            document.getElementById("album").setAttribute("src", track.album.images[0].url);
        }));


        document.getElementById('interact').onclick = function() {
            player.pause();
            document.getElementById('interactContainer').style.display = "none";
            document.getElementById('content').style.display = "block";
            fetch(httpUrl + "/interact", {
                method: 'POST'
            });
        };
    }

    function ConnectToWebSocket()
    {
        ws = new WebSocket("ws://localhost:9999/connect");

        ws.addEventListener('message', (m) => {
            LogEvent("WS: ", m.data);
            let data = m.data.split(":");
            switch (data[0])
            {
                case 'play':
                    let uri = data[1]; 
                    console.log("Don't know what to do with this " + data);
                    break;
                case 'seek':
                    let ms = parseInt(data[1]);
                    player.seek(ms).then(() => {
                        console.log("seek to " + ms + "!");
                    });
                    break;
                case 'pause':
                    player.pause().then(() => {
                        console.log("paused!");
                    });
                    break;
                case 'reset':
                    player.seek(0).then(() => {
                        player.resume().then(() => {
                            console.log("reset!");
                        });
                    });
                    break;
                case 'resume':
                    let timestamp = parseInt(data[1]);
                    let progress = Date.now() - timestamp;
                    LogEvent("resume", progress);
                    player.seek(progress).then(() => {
                        player.resume().then(() => {
                            console.log("resumed!");
                        });
                    })
                    break;
                case 'volume':
                    clearTimeout(volumeCooldown);
                    volumeCooldown = setTimeout(() =>
                    {
                        let volume = parseFloat(data[1]);
                        player.setVolume(volume).then(() => {
                            console.log("volume updated");
                        });
                    }, 1000);
                    break;
                default:
                    console.log("invalid web socket message", m.data);
            }
        });
        console.log(ws);
    }

    function LogEvent(eventType, message)
    {
        document.getElementById("log").innerHTML += '</br>' + "<em>" + eventType + "</em>: " + message
    }

    </script> 
    
    <div id="content" style="display: none">
        <img src="loading.webp" id="album" alt="album cover"/>
        <h2 id="title"></h2>
        <p id="artist"></p>
        <input type="range" id="progress"/>
        <p id="timer"></p>
        <div id="logContainer">
            <p id="log"><span style="text-align: center; display: inline-block; width: 100%">Logs</span></p>
        </div>
    </div>
    <div id="interactContainer">
        <button id="interact">Click to get started!</button>
    </div>
  </body>
</html>

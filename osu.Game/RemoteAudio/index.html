<!DOCTYPE html>
<html>
  <head>
    <title>Spotify Web Playback SDK Quick Start</title>
    <style>
        * {
            font-weight: 100;  
            padding: 0; 
            margin: 0;
        }

        html {
            height: 100%;
        }

        body {
            height: 100%;
            margin: 0;
            background-repeat: no-repeat;
            background-attachment: fixed;
            background-image: linear-gradient(to bottom right, rgba(89,79,78,255), rgba(24,24,24,255));
            
        }

        img {
            display: block;
            margin-left: auto;
            margin-right: auto;
            width: 40%;
            margin-top: 40px;
        }

        h2 {
            margin-left: 30%;
            color: rgba(254,254,252,255);
        }
        
        #progress {
            width: 40%;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        p {
            margin-left: 30%;
            color: rgba(194,193,191,255);
        }


    </style>
  </head>
  <body>
    <script src="https://sdk.scdn.co/spotify-player.js"></script>
    <script defer>

    let httpUrl = "http://localhost:9999";
    
    window.onSpotifyWebPlaybackSDKReady = () => {

        // Get the token from the main program API
        let token;
        fetch(httpUrl + "/token")
        .then((res) => res.json())
        .then((data) => {
            token = data;
            player.connect();
            console.log("Connected with token: " + data);
        })
        .catch((err) => {
            console.log("Server is not open yet: " + err);
        });
        
        // Use token to create the Spotify player
        const player = new Spotify.Player({
            name: 'Web Playback SDK Quick Start Player',
            getOAuthToken: cb => {cb(token); }
        });

        // Webpage is registered as a device
        player.addListener('ready', ({ device_id }) => {
            console.log('Ready with Device ID', device_id);
            fetch(httpUrl + "/device?id=" + device_id,
            {
                method: 'POST'
            });
        });

        // erorrs
        player.addListener('not_ready', ({ device_id }) => {
            console.log('Device ID has gone offline', device_id);
        });

        player.addListener('initialization_error', ({ message }) => { 
            console.error(message);
        });

        player.addListener('authentication_error', ({ message }) => {
            console.error(message);
        });

        player.addListener('account_error', ({ message }) => {
            console.error(message);
        });

        // Playback events
        player.addListener("progress", (o) => {
            document.getElementById("progress").value = o.position;
            let minutes = Math.floor(o.position/60000)
            let seconds = Math.floor((o.position % 60000)/1000);
            document.getElementById("timer").innerText = minutes + ":" + seconds.toString().padStart(2, "0");
        });

        // connect to the socket 
        var ws = new WebSocket("ws://localhost:9999/connect")

        ws.addEventListener('message', (m) => {
            let data = m.data.split(":");
            switch (data[0])
            {
                case 'play':
                    let uri = data[1]; 
                    console.log("Don't know what to do with this " + data);
                    break;
                case 'seek':
                    let ms = parseInt(data[1]);
                    player.seek(ms).then(() => {
                        console.log("seek to " + ms + "!");
                    });
                    break;
                case 'pause':
                    player.pause().then(() => {
                        console.log("paused!");
                    });
                    break;
                case 'resume':
                    player.resume().then(() => {
                        console.log("resumed!");
                    });
                    break;
                default:
                    console.log("invalid web socket message", m.data);
            }
        });
        console.log(ws);

        // State changed! Update the UI and send the state to the main program via http request
        player.addListener("player_state_changed", (state => {
            if (!state)
                return;

            // Send state to main program
            fetch(httpUrl 
            + "/state?ms=" + state.position.toString() 
            + "&timestamp=" + Date.now() 
            + "&paused=" + state.paused, 
            {
                method: 'POST'
            });

            // Update UI
            let track = state.track_window.current_track;

            let bar = document.getElementById("progress");
            bar.setAttribute("min", 0);
            bar.setAttribute("max", track.duration_ms);

            let artists = "";
            for (let a in track.artists)
            {
                artists += track.artists[a].name + "\n";
            }
            let titleElem = document.getElementById("title");
            let artistElem = document.getElementById("artist");
            if (titleElem.innerText == track && artistElem.innerText == artists) // ensure that the image does not get unnecessarily refreshed
                return;

            titleElem.innerText = track.name;
            artistElem.innerText = artists;
            document.getElementById("album").setAttribute("src", track.album.images[0].url);

        }));


        document.getElementById('interact').onclick = function() {
            player.pause();
            document.getElementById('interactContainer').style.display = "none";
            document.getElementById('content').style.display = "block";
            fetch(httpUrl + "/interact", {
                method: 'POST'
            });
        };
    }

    </script> 
    
    <div id="content" style="display: none">
        <img src="loading.webp" id="album" alt="album cover"/>
        <h2 id="title"></h2>
        <p id="artist"></p>
        <input type="range" id="progress"/>
        <p id="timer"></p>
    </div>
    <div id="interactContainer">
        <button id="interact">Click to get started!</button>
    </div>
  </body>
</html>
